name: Flowing Water Build & Patch
on: [push]

jobs:
  build_job:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Compile Dylib
        run: |
          clang++ -dynamiclib -arch arm64 \
          -isysroot $(xcrun --sdk iphoneos --show-sdk-path) \
          -miphoneos-version-min=14.0 \
          -std=c++17 \
          src/main.mm -o flowing_water.dylib \
          -framework Foundation -framework UIKit -lc++ \
          -fobjc-arc -O3

      - name: Patch IPA
        run: |
          # 1. Install the injection tool
          brew install insert_dylib

          # 2. Setup the IPA (Assuming you named it 'game.ipa' in your repo)
          unzip game.ipa -d temp_folder
          APP_NAME=$(ls temp_folder/Payload/)
          BINARY_NAME="Roblox" # Change this if the game binary is named differently

          # 3. Move dylib and inject
          cp flowing_water.dylib "temp_folder/Payload/$APP_NAME/"
          insert_dylib --inplace "@executable_path/flowing_water.dylib" "temp_folder/Payload/$APP_NAME/$BINARY_NAME"

          # 4. Pack it back up
          cd temp_folder && zip -r ../FlowingWater_Injected.ipa . && cd ..

      - name: Upload Final IPA
        uses: actions/upload-artifact@v4
        with:
          name: FlowingWater-Injected-App
          path: FlowingWater_Injected.ipa
